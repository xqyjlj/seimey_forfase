# 广东工业大学FSAE车队电控上位机通信协议

## 通信协议详述

​	本上位机采用`CRC16_MODBUS`数据校验，以数据结尾符号(`“\n”`,`”\r\n"`)进行数据分包。

## 帧格式

### 光电门

#### 读取

> 本功能需要功能标识符：`0x01`。

- 上位机发送：

  | 字节 |  1   |  2   |   3    |     4     |     5     |   6    |
  | :--: | :--: | :--: | :----: | :-------: | :-------: | :----: |
  | 内容 | 0xaa | 0x01 | 查询字 | CRC高字节 | CRC低字节 | `‘\n’` |

  查询字为0时才会响应光电门数据，其他作为开发者调试用。

- 下位机响应：

  | 字节 |  1   | 2、3 |    4、5、6、7    |     8     |     9     |   10   |
  | :--: | :--: | :--: | :--------------: | :-------: | :-------: | :----: |
  | 内容 | 0x01 | 圈数 | 数据（单位`ms`） | CRC高字节 | CRC低字节 | `‘\n’` |

##### 示例

> 发送一个时间为`1000ms`，圈数为`16`的数据。

- 上位机发送：

  | 字节 |  1   |  2   |  3   |  4   |  5   |  6   |
  | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
  | 内容 | 0xaa | 0x01 | 0x00 | 0x70 | 0x50 | 0x0D |
  
- 下位机响应：
  | 字节 |  1   |  2   |  3   |  4   |  5   |
  | :--: | :--: | :--: | :--: | :--: | :--: |
  | 内容 | 0x01 | 0x00 | 0x10 | 0x00 | 0x00 |
  | 字节 |  6   |  7   |  8   |  9   |  10  |
  | 内容 | 0x03 | 0xE8 | 0xBD | 0xCA | 0x0D |

#### 清零

> 本功能需要功能标识符：`0x02`。

上位机发送：

- 上位机发送：

  | 字节 |  1   |  2   |   3    |     4     |     5     |   6    |
  | :--: | :--: | :--: | :----: | :-------: | :-------: | :----: |
  | 内容 | 0xaa | 0x02 | 任务字 | CRC高字节 | CRC低字节 | `‘\n’` |
  
   任务字为0时才会响应光电门数据，其他作为开发者调试用。

- 下位机响应：

  | 字节 |  1   |  2、3  |     4     |     5     |   6    |
  | :--: | :--: | :----: | :-------: | :-------: | :----: |
  | 内容 | 0x02 | 响应字 | CRC高字节 | CRC低字节 | `‘\n’` |
  
  响应字为`6F 6B`时即为清空光电门数据。
  
##### 示例

> 清空光电门数据。

- 上位机发送：

  | 字节 |  1   |  2   |  3   |  4   |  5   |  6   |
  | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
  | 内容 | 0xaa | 0x02 | 0x00 | 0x80 | 0x50 | 0x0D |
  
- 下位机响应：
  | 字节 |  1   |  2   |  3   |  4   |  5   |  6   |
  | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
  | 内容 | 0x02 | 0x6F | 0x6B | 0x1F | 0xBC | 0x0D |

### 无线电台

> 无线电台分为心跳包和信息包，心跳包内有必要的按时更新的数据（如车速），信息包内则有一些故障信息，比如单体温度过高之类。且数据是自动源源不断的发送，不需要上位机来发送指令。

#### 心跳包

> 心跳包主要是为一些需要定时更新的数据，比如电压，温度，车速。

| 字节 |  1   |  2   | 3    | 4    | 5    | 6    |
| :--: | :--: | :--: | ---- | ---- | ---- | ---- |
| 内容 | 0x03 | 0x03 |      |      |      |      |
| 示例 |      |      |      |      |      |      |

#### 信息包

> 信息包内则有一些故障信息，比如单体温度过高之类。由于采用校验可能会因为一小段的误码而错失本次信息，所以采用明文传输（以LOG方式输出）

